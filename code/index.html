<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Help on help</title>
  <script type="text/javascript" src="date.format.js"></script>
  <script type="text/javascript" src="client/settings.js"></script>
  <script type="text/javascript" src="client/channel.js"></script>
  <script type="text/javascript">
	var chatSession = { id: 0, user: 0, name: '' };
	var channels = {};
	var server_host = '';
	var msgHandlers = [];
	var default_title;
	var msg_counter = 0;
	var is_active = true;
	
	function presentLoginForm() {
		var form = document.getElementById('loginForm');
		form.elements['id'].value = id;
		form.elements['name'].value = name;		
	}
	
	function auth( authData ) {
		var xhr = new XMLHttpRequest();		
		xhr.open( 'POST', server_host + 'server/auth', true );
		xhr.setRequestHeader( 'Content-type', 'application/x-www-form-urlencoded' );
		xhr.onreadystatechange = (function _wrapXhr(x){ return function(){authProc(x);} })(xhr);
		
		var dataObj = encodeObject( authData );
		console.log( 'auth string: ' + dataObj );
		console.log( 'auth object:: ' + JSON.stringify( dataObj ) );
		xhr.send( dataObj );
		
		return false;
	}
	
	function authProc( xhr ) {
		if ( xhr.readyState === 4 && xhr.status == 200 ) {
			var response = JSON.parse( xhr.responseText );
			
			if ( response.ok ) authOk( response );
			else authErr( response );
		} else if ( xhr.readyState === 4 ) {
			var response = JSON.parse( xhr.responseText );
			if ( response != '' )
				showLoginError( 'Server says "' + response + '", but we have no idea what that means' );
			else
				showLoginError( 'Sorry, we have no idea what just happened' );
		}
	};
	
	function authOk( response ) {
		if ( !response['session'] ) return;
		chatSession.id = response.session;
		chatSession.user = response.user;
		chatSession.name = response.username;
		Settings.user = chatSession.user;
		Settings.name = chatSession.name;
		
		switchPanel( 'chat' );
		
		if ( response['pin'] )
			showPin( response.pin );
		
		Setttings.save();
		startListener();
	}
	function authErr( response ) {
		chatSession.id = 0;
		
		switchPanel( 'login' );
		showLoginError( response.message );
	}

	function encodeObject(data) {
		if(!data) return false;
		var pairs = [],
			regexp = /%20/g;

		for(var name in data) {
			var value = data[name].toString(),
			pair = encodeURIComponent(name).replace(regexp, '+') + '=' + encodeURIComponent(value).replace(regexp, '+');

			pairs.push(pair);
		}

		return pairs.join('&');
	}
	function convertFormToObject( form ) {
		var obj = {};
		for ( var i in form.elements ) {
			if ( form.elements[i]['name'] !== undefined && form.elements[i].name != '' )
				obj[ form.elements[i].name ] = form.elements[i].value;
		}
		return obj;
	}
	
	function switchPanel( panel ) {
		switch( panel ) {
			case 'chat':
				document.getElementById( 'chat' ).style.visibility = 'visible';
				document.getElementById( 'tabs' ).style.visibility = 'visible';
				document.getElementById( 'login' ).style.visibility = 'hidden';
				break;
			case 'login':
				document.getElementById( 'chat' ).style.visibility = 'hidden';
				document.getElementById( 'tabs' ).style.visibility = 'hidden';
				document.getElementById( 'login' ).style.visibility = 'visible';
				break;
			default:
				// TODO: tab processing
		}
	}
	function showLoginError( message ) {
		var msgNode = document.createTextNode( message );
		var errorNode = document.getElementById( 'loginError' );
		if ( errorNode.hasChildNodes() ) {
			errorNode.replaceChild( msgNode, errorNode.firstChild );
		} else {
			errprMpde.appendChild( msgNode );
		}
	}

    var lastSentMessageId = Infinity,
        lastEventId = null;

    function checkId() {
      if (lastEventId >= lastSentMessageId) {
        lastSentMessageId = Infinity;
      }
    }
	
	function makeChannelEntry( msg ) {
		var div = document.createElement('div'),
			timestamp = document.createElement( 'div' ),
			author = document.createElement( 'div' ),
			text = document.createElement( 'div' );
		
		timestamp.className = 'timestamp';
		var ts = new Date(msg.ts);
		timestamp.innerHTML = ts.format('HH:MM');
		div.appendChild( timestamp );
		
		author.innerHTML = msg.author;
		author.className = 'author';
		div.appendChild( author );
		
		var msg_text = msg.msg;
		switch( msg.msgType ) {
			// System messages
			case -1: msg_text = 'Это же ' + msg_text + '!'; break;
			case -2: msg_text = 'Пока, ' + msg_text + '!'; break;
		}
		text.innerHTML = linkify( msg_text.replace( /\n/g, '<br/>' ) );
		text.className = 'text';
		div.appendChild( text );
		
		div.className = msg.owner;
		/*msgs.appendChild( div );
		div.scrollIntoView(); */
		
		return div;
	}
	
	function onUserMessage( msg ) {
		var ch = channels[ msg.channel ];
		if ( ch === undefined ) return;
		
		// add to channel history
		switch ( typeof( ch.history[ msg.ts ] ) ) {
			case 'undefined': ch.history[ msg.ts ] = msg; break;
			case 'string': ch.history[ msg.ts ] = [ ch.history[ msg.ts ], msg ]; break;
			case 'array': ch.history.push( msg ); break;
		}
		ch.addToView( msg, makeChannelEntry( msg ) );
		
	}
	
	
	function visibilityChange() {
		if ( !( document.hidden || !is_active ) ) {
			document.title = default_title;
			msg_counter = 0;
		} else {
			document.title = ' | ' + default_title;
		}
	}
	function onBlur() {
		is_active = false;
		visibilityChange();
	};
	function onFocus(){
		is_active = true;
		visibilityChange();
	};
	function offscreenMsgHandler( msg ) {
		if ( document.hidden || !is_active ) {
			++msg_counter;
			document.title = '(' + msg_counter + ')' + ' | ' + default_title;
		}
	}
	
	function startListener() {
		if ( 0 == chatSession.id ) return false;
		
		msgHandlers[ 'msgAdd' ] = addMsgHandler;
		msgHandlers[ 'visChange' ] = offscreenMsgHandler;
		
		window.onfocus = onFocus;
		window.onblur = onBlur;
		document.addEventListener( 'visibilitychange', visibilityChange );
		
		// Only start listener after we authorized
		var msgs = document.getElementById('msgs'),
			es = new EventSource( server_host + 'server/?id=' + chatSession.id );
			
		// Chat message listener
		es.addEventListener('message', function (event) {
				lastEventId = +event.lastEventId;
				var msg = JSON.parse(event.data);

				// call handlers
				for ( var i in msgHandlers )
					msgHandlers[i]( msg );
				
				checkId();
			}
		);
		
		// TODO: add event listeners (such as contact list update)
	}

    function onDomReady() {
		default_title = document.title;
		if ( loadSession() ) {
			//auth();
			presentLoginForm();
		}
		
		setTimeout( function() {
			document.getElementById('message').onkeypress = function() {
				if ( event.keyCode == 13 && !event.ctrlKey && !event.shiftKey ) { 
					// send with "Enter", newline with "Shift+Enter"
						return post(); 
					}
				};
			}, 10);
    }

    window.onload = onDomReady; // DOMContentLoaded can't prevent NSL under Firefox 10, 11

    function post() {
		var message = document.getElementById('message').value;
		if (!message) {
			return false;
		}

		lastSentMessageId = Infinity;

		var xhr = new XMLHttpRequest();
		xhr.open('POST', server_host + 'server/?id=' + encodeURIComponent( chatSession.id ), true);
		xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
		xhr.onreadystatechange = function () {
			if (xhr.readyState === 4) {
				lastSentMessageId = +xhr.responseText || Infinity;
				checkId();
			}
		};
		// Message text is sent in POST body
		xhr.send( encodeObject( { message: message } ) );

		document.getElementById('message').value = '';
		return false;
    }
	
	// convert links to clickable links
	function linkify(text) {  
		var urlRegex =/(\b(https?|ftp|file):\/\/[-A-Z0-9А-Я+&@#\/%?=~_|!:,.;\(\)]*[-A-ZА-Я0-9+&@#\/%=~_|\(\)])/ig;  
		return text.replace(urlRegex, function(url) {  
				return '<a href="' + url + '" target="_blank">' + url + '</a>';  
			}
		);
	}	

  </script>
  <style type="text/css">
	html * { font-family: Trebuchet MS; font-size: 12pt }
	fieldset { border: none; padding: 0em; margin: 0em }
	#msgs {
		position: absolute;
		overflow-y: scroll;
		bottom: 6em;
		right: 1em;
		left: 1em;
		top: 1em;
	}
    #msgs > div {
		display: block;
		margin-top: 0.3em;
		overflow: hidden;
		position: relative;
    }
	#msgs > div .timestamp { float: right; width: 6em }
	#msgs > div .author { width: 8em; text-align: right; float: left }
	#msgs > div .text { margin: 0em 9em }
	#chat { visibility: hidden; position: absolute; top: 0px; bottom: 0px; left: 0px; right: 0px; }
	#chat form { height: 4em; position: absolute; padding-left: 9em; padding-right: 7em; bottom: 1em; left: 1em; right: 1em }
	#login { position: absolute; display: table; left: 1em; top: 1em }
	#login form { display: table-row }
		
	#message { width: 100%; height: 4em; padding: 0px; margin: 0px }
	#message + input { height: 4em; width: 6em; position: absolute; right: 0px; top: 0px; padding: 0em; }
	
	
	.self { color: gray; }
	.other { color: black; }
	.system { color: black; font-style: italic }
	
	.author { font-weight: bold; margin-right: 1em; width: 10em }
	.author.self { color: blue; }
	.author.other { color: black; }
	
	.timestamp { color: gray;}
  </style>
</head>
<body>
	<div id="tabs">
	</div>
	<div id="chat">
		<div id="msgs"></div>
		<form action="?" onsubmit="return post();"><fieldset>
			<textarea type="text" name="message" id="message"></textarea>
			<input type="submit" value="Send" />
		</fieldset></form>
	</div>
	<div id="login">
		<form action="?" onsubmit="return auth(convertFormToObject(this.form));" id="loginForm"><fieldset>
			<label>Войти как: <input type="text" name="name" id="name" required /></label>
			<label>Пин: <input type="text" name="pin" id="pin" size="5" maxlength="4" value=""/></label>
			<input type="hidden" name="id" value="0" /></label>
			<input id="login_submit" type="submit" value="Ок" />
			<p id="loginError"></p>
		</fieldset></form>
	</div>
	
</body>
</html>